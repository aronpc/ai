#!/bin/bash
# Instalar hooks do Sprint Management
# Configura atalhos do git para usar os scripts

HOOKS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/bin"
PROJECT_ROOT="$(git rev-parse --show-topoplevel 2>/dev/null)"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_banner() {
    echo -e "${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë  üìã Sprint Management - Hooks Installer            ‚ïë"
    echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $@${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $@${NC}" >&2
}

print_info() {
    echo -e "${YELLOW}‚Ñπ $@${NC}"
}

check_git_repo() {
    if [ -z "$PROJECT_ROOT" ]; then
        print_error "N√£o est√° em um reposit√≥rio Git"
        exit 1
    fi
}

install_hooks() {
    local hooks_dir="$PROJECT_ROOT/.git/hooks"

    print_info "Hooks s√£o scripts bash que podem ser usados via atalhos git"
    print_info "Scripts instalados em: ${GREEN}$HOOKS_DIR${NC}"
}

create_git_aliases() {
    print_info "Criando atalhos git..."

    # Atalho para aber tracking
    if ! git config --local --get alias.sprint-track >/dev/null 2>&1; then
        git config --local alias.sprint-track "!bash $HOOKS_DIR/sprint-track"
        print_success "Atalho 'git sprint-track' criado"
    else
        print_info "Atalho 'git sprint-track' j√° existe"
    fi

    # Atalho para aber √∫ltimo sprint
    if ! git config --local --get alias.sprint-last >/dev/null 2>&1; then
        git config --local alias.sprint-last "!bash $HOOKS_DIR/sprint-last"
        print_success "Atalho 'git sprint-last' criado"
    else
        print_info "Atalho 'git sprint-last' j√° existe"
    fi

    # Atalho para atualizar tracking
    if ! git config --local --get alias.sprint-update-tracking >/dev/null 2>&1; then
        git config --local alias.sprint-update-tracking "!bash $HOOKS_DIR/sprint-update-tracking"
        print_success "Atalho 'git sprint-update-tracking' criado"
    else
        print_info "Atalho 'git sprint-update-tracking' j√° existe"
    fi

    # Atalho para criar novo sprint
    if ! git config --local --get alias.sprint-new >/dev/null 2>&1; then
        git config --local alias.sprint-new "!f() { bash $HOOKS_DIR/sprint-new \"\$@\"; };"
        print_success "Atalho 'git sprint-new [nome]' criado"
    else
        print_info "Atalho 'git sprint-new' j√° existe"
    fi
}

create_sprints_structure() {
    local sprints_dir="$PROJECT_ROOT/sprints"

    if [ ! -d "$sprints_dir" ]; then
        print_info "Criando estrutura de sprints/..."
        mkdir -p "$sprints_dir"

        cat > "$sprints_dir/tracking.md" <<'EOF'
# Sprints Tracking

Este arquivo rastreia todos os sprints planejados e em andamento para o projeto.

## Status dos Sprints

| Sprint | Status | Data In√≠cio | Data Fim | Descri√ß√£o |
|--------|--------|-------------|----------|-----------|

## Legenda de Status

- **Planejado**: Sprint planejado, aguardando in√≠cio
- **Em Andamento**: Sprint em execu√ß√£o
- **Conclu√≠do**: Sprint finalizado e implementado
- **Cancelado**: Sprint cancelado

## Como Criar Novo Sprint

1. Criar arquivo \`sprints/XXX-nome-do-sprint.md\` onde XXX √© o n√∫mero sequencial
2. Adicionar entrada neste arquivo de tracking
3. Atualizar status conforme progresso
EOF

        print_success "Estrutura de sprints/ criada com tracking.md b√°sico"
    else
        print_info "Estrutura de sprints/ j√° existe"
    fi
}

show_usage_info() {
    echo ""
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${BLUE}‚ïë  Comandos Dispon√≠veis                                  ‚ïë${NC}"
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${GREEN}Comandos Git:${NC}"
    echo "  git sprint-track             - Aber tracking.md no editor"
    echo "  git sprint-last              - Aber √∫ltimo sprint modificado"
    echo "  git sprint-update-tracking    - Atualizar tracking.md com sprints recentes"
    echo "  git sprint-new <nome>        - Criar novo sprint com template"
    echo ""
    echo -e "${GREEN}Scripts Diretos:${NC}"
    echo "  $HOOKS_DIR/sprint-track             - Script para aber tracking"
    echo "  $HOOKS_DIR/sprint-last               - Script para aber √∫ltimo sprint"
    echo "  $HOOKS_DIR/sprint-update-tracking      - Script para atualizar tracking"
    echo "  $HOOKS_DIR/sprint-new <nome>         - Script para criar novo sprint"
    echo ""
    echo -e "${YELLOW}üí° Dica: Os scripts tamb√©m podem ser executados diretamente!${NC}"
}

# Main
main() {
    print_banner

    cd "$PROJECT_ROOT" 2>/dev/null || {
        print_error "N√£o foi poss√≠vel mudar para raiz do projeto"
        exit 1
    }

    check_git_repo
    install_hooks
    create_git_aliases
    create_sprints_structure

    show_usage_info

    echo ""
    print_success "Instala√ß√£o conclu√≠da!"
    echo ""
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
