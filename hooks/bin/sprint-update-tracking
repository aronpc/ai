#!/bin/bash
# Hook: Atualizar tracking.md com √∫ltimos sprints modificado
# Uso: git sprint-update ou manualmente

SPRINTS_TRACKING="sprints/tracking.md"
SPRINTS_DIR="sprints"

extract_info() {
    local f="$1"
    # Extrair nome da primeira linha
    local name=$(grep "^# " "$f" | head -1 | sed 's/^# //; s/^: *//; s/[[:space:]]*$//' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')
    # Extrair status
    local status=$(grep -i "^[* *Status:" "$f" 2>/dev/null | sed 's/^.*:[[:space:]]*//; s/[[:space:]]*$//' | tr -d '\n' '*' | head -1)
    echo "$name|$status"
}

if [ ! -f "$SPRINTS_TRACKING" ]; then
    echo "Arquivo $SPRINTS_TRACKING n√£o encontrado!"
    exit 1
fi

if [ ! -d "$SPRINTS_DIR" ]; then
    echo "Diret√≥rio $SPRINTS_DIR n√£o encontrado!"
    exit 1
fi

# Encontrar sprints modificado (√∫ltimos 30 dias)
modified=()
for f in "$SPRINTS_DIR"/*.md; do
    if [ "$(basename "$f")" != "tracking.md" ]; then
        # Verificar se foi modificado nos √∫ltimos 30 dias
        if [ "$(find "$SPRINTS_DIR" -name "*.md" -mtime -30 -printf)" ]; then
            modified+=("$f")
        fi
    fi
done

if [ ${#modified[@]} -eq 0 ]; then
    echo "Nenhum sprint modificado recentemente encontrado."
    exit 0
fi

echo "üìã Atualizando tracking.md com ${#modified[@]} sprint(s)..."
echo ""

# Criar arquivo tempor√°rio
temp_file=$(mktemp)

# Processar tracking.md linha por linha
in_sprint_table=0
while IFS= read -r line || [ -n "$in_sprint_table" ]; do
    # Encontrar in√≠cio da tabela
    if [[ $line == *"| Sprint | Status"* ]]; then
        in_sprint_table=1
        echo "$line"
        continue
    fi

    if [ $in_sprint_table -eq 1 ]; then
        # Verificar se sa√≠mos da tabela
        if [[ $line == *"##"* ]] || [[ $line == *"```"* ]] || [ -z "$line" ]; then
            break
        fi
        echo "$line"
    else
        echo "$line"
    fi
done < "$SPRINTS_TRACKING" >> "$temp_file"

mv "$temp_file" "$SPRINTS_TRACKING"

# Adicionar ao git se modificado
if git diff --quiet "$SPRINTS_TRACKING" 2>/dev/null; then
    echo "‚úÖ tracking.md foi modificado, adicionando ao git..."
    git add "$SPRINTS_TRACKING" 2>/dev/null
fi

echo "‚úÖ Ataliza√ß√£o conclu√≠da!"
